{% extends "base.html" %}
{% import "lib.html" as lib %}

{% block head %}
  <title>Add crash</title>
  <style type="text/css">
    #map { width: 100%; height: 200px; }
  </style>
{% endblock %}

{% macro victim(victim=None) -%}
  {% call lib.panel("Victim", "victim-form-group") %}
      {% if victim %} 
        {{ lib.panel_input("First Name", "firstname-input", value=victim.first) }}
        {{ lib.panel_input("Last Name", "lastname-input", value=victim.last) }}
        {{ lib.panel_input("Age", "age-input", type="number", value=victim.age) }}
      {% else %}
        {{ lib.panel_input("First Name", "firstname-input") }}
        {{ lib.panel_input("Last Name", "lastname-input") }}
        {{ lib.panel_input("Age", "age-input", type="number") }}
      {% endif %}
      {{ lib.panel_intr_sml_btn("Delete", class="del-victim-btn") }}
  {% endcall %}
{%- endmacro %}

{% macro tag(tag=None) -%}
  {% call lib.panel("Tag", "tag-form-group") %}
      {% if tag %} 
        {{ lib.panel_input("Tag", "tag-input", value=tag.name) }}
      {% else %}
        {{ lib.panel_input("Tag", "tag-input") }}
      {% endif %}
      {{ lib.panel_intr_sml_btn("Delete", class="del-tag-btn") }}
  {% endcall %}
{%- endmacro %}

{% macro link(link=None) -%}
  {% call lib.panel("Link", "link-form-group") %}
      {% if link %} 
        {{ lib.panel_input("Name", "link-name-input", value=link.name) }}
        {{ lib.panel_input("Link", "link-input", value=link.link) }}
      {% else %}
        {{ lib.panel_input("Name", "link-name-input") }}
        {{ lib.panel_input("Link", "link-input") }}
      {% endif %}
      {{ lib.panel_intr_sml_btn("Delete", class="del-link-btn") }}
  {% endcall %}
{%- endmacro %}

{% macro crash_info(crash=None) -%}
  {% call lib.panel("Crash Info") %}
      {% if crash %} 
        {{ lib.panel_input("Date", "date-input",
                           value=crash.date.isoformat(),
                           type="datetime-local") }}
        {{ lib.panel_input("Latitude", "latitude-input",
                           value=crash.latitude,
                           type="number") }}
        {{ lib.panel_input("Longitude", "longitude-input",
                           value=crash.longitude,
                           type="number") }}
      {% else %}
        {{ lib.panel_input("Date", "date-input", type="datetime-local") }}
        {{ lib.panel_input("Latitude", "latitude-input", type="number") }}
        {{ lib.panel_input("Longitude", "longitude-input", type="number") }}
      {% endif %}
      <div id="map"></div>
  {% endcall %}
{%- endmacro %}

{% block body %}
  <div class="container" style="width:500px;">
    <form id="crash-form" class="form-horizontal">
      <!-- Victim -->
      <div id="victims-container">
        {% if crash %}
          {% for _victim in crash.victims %}
            {{ victim(_victim) }}
          {% endfor %}
        {% else %}
          {{ victim() }}
        {% endif %}
      </div><!-- div id="victims-container" -->
      {{ lib.panel_extr_left_sml_btn("Add Victim", "add-victim-btn") }}

      <!-- Tags -->
      <div id="tags-container">
        {% if crash %}
          {% for _tag in crash.tags %}
            {{ tag(_tag) }}
          {% endfor %}
        {% else %}
          {{ tag() }}
        {% endif %}
      </div><!-- div id="tags-container" -->
      {{ lib.panel_extr_left_sml_btn("Add Tag", "add-tag-btn") }}

      <!-- Links -->
      <div id="links-container">
        {% if crash %}
          {% for _link in crash.links %}
            {{ link(_link) }}
          {% endfor %}
        {% else %}
          {{ link() }}
        {% endif %}
      </div><!-- div id="links-container" -->
      {{ lib.panel_extr_left_sml_btn("Add Link", "add-link-btn") }}

      <!-- Date, Latitude, and Longitude -->
      <div id="crash-info-container"> {{ crash_info(crash) }} </div>

      <!-- Create button -->
      <div class="form-group form-group-lg">
        <div class="col-sm-2">
          <button id="create-crash-btn" type="submit" class="btn btn-primary btn-lg">
            {{ "Edit" if crash else "Create" }}
          </button>
        </div>
      </div>
    </form>
  </div>
{% endblock %}

{% block javascript %}
  <script type="text/javascript">

$(document).ready(function () {
  // Victim add & delete buttons:
  $(".del-victim-btn").click(function (event) {
    event.preventDefault();
    $(this).parents(".victim-form-group").remove();
  });
  $(".add-victim-btn").first().click(function (event) {
    event.preventDefault();
    $(".victim-form-group").first().clone(true).appendTo("#victims-container");
  });

  // Tag add & delete buttons:
  $(".del-tag-btn").click(function (event) {
    event.preventDefault();
    $(this).parents(".tag-form-group").remove();
  });
  $(".add-tag-btn").first().click(function (event) {
    event.preventDefault();
    $(".tag-form-group").first().clone(true).appendTo("#tags-container");
  });

  // Link add & delete buttons:
  $(".del-link-btn").click(function (event) {
    event.preventDefault();
    $(this).parents(".link-form-group").remove();
  });
  $(".add-link-btn").first().click(function (event) {
    event.preventDefault();
    $(".link-form-group").first().clone(true).appendTo("#links-container");
  });

  // Create button:
  $("#create-crash-btn").click(function (event) {
    // Send crash data to server:
    // - Collect victim(s) data
    // - Collect tag(s) data
    // - Collect link(s) data
    // - Collect rest of crash data
    // - POST as JSON

    event.preventDefault();
    var crash = {
          victims: [],
          tags: [],
          links: []
        };

    $(".victim-form-group").each(function() {
      crash.victims.push({
        first: $(this).find(".firstname-input").first().val(),
        last: $(this).find(".lastname-input").first().val(),
        age: parseInt($(this).find(".age-input").first().val()),
      });
    });
    $(".tag-form-group").each(function() {
      crash.tags.push($(this).find(".tag-input").first().val());
    });
    $(".link-form-group").each(function() {
      crash.links.push({
        name: $(this).find(".link-name-input").first().val(),
        link: $(this).find(".link-input").first().val()
      });
    });
    crash.date = $(".date-input").first().val();
    crash.latitude = $(".latitude-input").first().val();
    crash.longitude = $(".longitude-input").first().val();

    $.ajax({
      type: "POST",
      url: "{{ "/crash/" + crash.id | string if crash else "/crash" }}",
      data: JSON.stringify(crash),
      dataType: "json",
      contentType: "application/json",
      success: function() {
        alert("Sent crash data");
      },
      error: function(jqXHR, textStatus, errorThrown) {
        alert("Failed to send crash data " + textStatus + " " + errorThrown);
      }
    });
  });
});

var map, marker = null;
function initMap() {
  var addMarker = function(latitude, longitude) {
    if (marker != null) {
      marker.setMap(null);
    }
    marker = new google.maps.Marker({
      position: { lat: latitude, lng: longitude },
      map: map
    });
  };

  map = new google.maps.Map(document.getElementById("map"), {
    center: {
      lat: {{ crash.latitude | string if crash else 37.5 }},
      lng: {{ crash.longitude | string if crash else -122.1 }}
    },
    zoom: 14,
    panControl: false,
    zoomControl: false,
    mapTypeControl: false,
    scaleControl: false,
    streetViewControl: false,
    overviewMapControl: false
  });

  {% if crash %}
    addMarker({{ crash.latitude }}, {{ crash.longitude }});
  {% endif %}

  map.addListener('click', function(event) {
    $(".latitude-input").first().val(event.latLng.lat());
    $(".longitude-input").first().val(event.latLng.lng());
    addMarker(event.latLng.lat(), event.latLng.lng());
  });
}
  </script>

  <script async defer
    src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCNR_PQxoUtbFLRaLGV3NNZIq7sjqKojYA&callback=initMap">
  </script>
{% endblock %}
