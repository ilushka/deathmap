<!DOCTYPE html>
<html>
  <head>
    <style type="text/css">
      html, body { height: 100%; margin: 0; padding: 0; }
      #map { height: 100%; }
    </style>
    <script src="{{ url_for('bower.static', filename='jquery/dist/jquery.min.js') }}"></script>
  </head>
  <body>
    <div id="map"></div>
    <script type="text/javascript">

var map;
function initMap() {
  map = new google.maps.Map(document.getElementById("map"), {
    center: { lat: 37.375476, lng: -121.822275 },
    zoom: 9
  });

  var buildInfoWindowContent = function(crash) {
    var content = $("<div></div>"),
        victims = crash.victims.reduce(function(prev, curr) {
            return prev + curr.first + " " + curr.last + " (" + curr.age + "), "; 
          }, "").slice(0, -2),
        links = crash.links.reduce(function(prev, curr, index) {
            return prev +
              $("<a />", {
                text: index + 1,
                href: curr.link,
                target: "_blank"
              }).prop("outerHTML") + 
              ", ";
          }, "").slice(0, -2),
        tags = crash.tags.reduce(function(prev, curr) {
            return prev + curr + ", ";
          }, "").slice(0, -2);
    content.append("<b>Victims:</b> " + victims + "<br />");
    content.append("<b>Date:</b> " + crash.date + "<br />");
    content.append("<b>Links:</b> " + links + "<br />");
    content.append("<b>Tags:</b> " + tags + "<br />");
    return content.prop("outerHTML");
  };

  $.ajax({url: "/crash/all"})
    .done(function(crashes) {
      var infowindow = new google.maps.InfoWindow();
      for (var ii = 0; ii < crashes.length; ++ii) {
        var crash = crashes[ii],
            marker = new google.maps.Marker({
              position: { lat: crash.latitude, lng: crash.longitude },
              map: map,
              title: crash.victims[0].first,
              crash: crash
            });
        
        marker.addListener("click",
          (function(_map, _marker) {
              return function() { 
                infowindow.setContent(buildInfoWindowContent(this.crash));
                infowindow.open(_map, _marker);
              };
            })(map, marker));
      }
    });
}

    </script>
    <script async defer
      src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCNR_PQxoUtbFLRaLGV3NNZIq7sjqKojYA&callback=initMap">
    </script>
  </body>
</html>
